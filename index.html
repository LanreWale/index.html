<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMPIRE v2.1 - Wallet Transfer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #0a0f1e 0%, #1a1f2e 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { max-width: 600px; width: 100%; background: rgba(18, 25, 40, 0.95); backdrop-filter: blur(10px); border-radius: 32px; padding: 32px; border: 1px solid rgba(255, 215, 0, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        /* Logo Banner */
        .logo-banner {
            text-align: center;
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(145deg, #000000, #1a1f2e);
            border-radius: 24px;
            border: 2px solid #FFD700;
            position: relative;
            overflow: hidden;
        }
        .logo-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        .empire-title { font-size: 48px; font-weight: 900; color: #FFD700; text-transform: uppercase; letter-spacing: 4px; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); margin-bottom: 8px; position: relative; }
        .empire-subtitle { font-size: 14px; color: #94a3b8; text-transform: uppercase; letter-spacing: 3px; position: relative; }
        .empire-tagline { font-size: 11px; color: #FFD700; margin-top: 8px; letter-spacing: 2px; opacity: 0.8; position: relative; }
        .crown-icon { font-size: 32px; filter: drop-shadow(0 0 10px #FFD700); margin-bottom: 5px; }
        
        .balance-card { background: linear-gradient(145deg, #1e293b, #0f172a); border-radius: 24px; padding: 24px; margin-bottom: 32px; border: 1px solid #FFD700; text-align: center; }
        .balance-label { color: #FFD700; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; }
        .balance-amount { color: white; font-size: 48px; font-weight: 800; }
        .input-group { margin-bottom: 20px; }
        label { color: #cbd5e1; font-size: 14px; font-weight: 500; display: block; margin-bottom: 8px; }
        input, select { width: 100%; padding: 16px; background: #1e293b; border: 2px solid #334155; border-radius: 16px; color: white; font-size: 16px; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: #FFD700; background: #2d3a4f; }
        button { width: 100%; padding: 16px; border: none; border-radius: 16px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.3s; margin-bottom: 12px; }
        .btn-primary { background: #FFD700; color: #0a0f1e; }
        .btn-primary:hover:not(:disabled) { background: #e6c200; transform: translateY(-2px); box-shadow: 0 10px 25px -5px #FFD700; }
        .btn-primary:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; }
        .btn-secondary { background: #334155; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #475569; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover:not(:disabled) { background: #059669; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .matches-container { background: #1e293b; border-radius: 16px; padding: 16px; margin: 20px 0; border: 1px solid #334155; max-height: 300px; overflow-y: auto; }
        .match-item { padding: 16px; margin-bottom: 8px; border: 1px solid #334155; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .match-item:hover { background: #2d3a4f; border-color: #FFD700; }
        .match-item.selected { background: #2d3a4f; border: 2px solid #FFD700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); }
        .match-name { color: #FFD700; font-weight: 700; font-size: 16px; }
        .match-details { display: flex; justify-content: space-between; color: #94a3b8; font-size: 13px; margin-top: 4px; }
        .match-bank { color: #cbd5e1; font-weight: 500; }
        .match-badge { background: #10b98120; color: #10b981; padding: 2px 8px; border-radius: 12px; font-size: 11px; border: 1px solid #10b981; margin-left: 8px; }
        
        .status { padding: 16px; border-radius: 16px; margin: 20px 0; text-align: center; font-weight: 500; display: none; }
        .status.success { background: #10b98120; border: 1px solid #10b981; color: #10b981; display: block; }
        .status.error { background: #ef444420; border: 1px solid #ef4444; color: #ef4444; display: block; }
        .status.info { background: #3b82f620; border: 1px solid #3b82f6; color: #3b82f6; display: block; }
        .status.pending { background: #f59e0b20; border: 1px solid #f59e0b; color: #f59e0b; display: block; }
        
        .progress-container { background: #1e293b; border-radius: 12px; padding: 16px; margin: 10px 0; display: none; }
        .progress-bar { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #e6c200); width: 0%; transition: width 0.3s ease; }
        .bank-attempt { color: #94a3b8; font-size: 13px; padding: 8px; background: #00000030; border-radius: 8px; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #FFD700; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; margin-right: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .approval-section { background: #1e293b; border-radius: 16px; padding: 20px; margin: 20px 0; border: 2px solid #FFD700; display: none; }
        .warning { color: #FFD700; font-size: 12px; margin-top: 5px; }
        .info-box { background: #2d3a4f; border-radius: 12px; padding: 15px; margin: 10px 0; font-size: 14px; color: #cbd5e1; }
        
        /* Receipt Modal - NO BALANCE */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 32px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            border: 2px solid #FFD700;
            position: relative;
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .receipt-header { text-align: center; margin-bottom: 24px; }
        .receipt-title { color: #FFD700; font-size: 24px; font-weight: 800; }
        .receipt-subtitle { color: #94a3b8; font-size: 12px; }
        .receipt-details { background: #00000030; border-radius: 16px; padding: 20px; margin: 20px 0; }
        .receipt-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #334155; }
        .receipt-row:last-child { border-bottom: none; }
        .receipt-label { color: #94a3b8; font-weight: 500; }
        .receipt-value { color: white; font-weight: 700; text-align: right; }
        .receipt-value.highlight { color: #10b981; font-size: 20px; }
        .receipt-footer { text-align: center; margin-top: 24px; }
        .btn-close { background: #FFD700; color: #0a0f1e; padding: 12px 24px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; width: auto; display: inline-block; }
        .btn-close:hover { background: #e6c200; }
        .receipt-icon { font-size: 48px; margin-bottom: 16px; }
        .txn-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
        }
        .status-badge-success { background: #10b98120; color: #10b981; border: 1px solid #10b981; }
        .status-badge-pending { background: #f59e0b20; color: #f59e0b; border: 1px solid #f59e0b; }
        #debug { color: #94a3b8; font-size: 12px; margin-top: 20px; border-top: 1px solid #334155; padding-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Empire Logo Banner -->
        <div class="logo-banner">
            <div class="crown-icon">üëë</div>
            <div class="empire-title">THE EMPIRE</div>
            <div class="empire-subtitle">COMMANDING THE FUTURE</div>
            <div class="empire-tagline">OF AFFILIATE MARKETING</div>
        </div>

        <div class="balance-card">
            <div class="balance-label">AVAILABLE BALANCE</div>
            <div class="balance-amount" id="balanceDisplay">$184,326.87</div>
        </div>

        <div class="input-group">
            <label>Amount (USD) *minimum $1</label>
            <input type="number" id="amount" placeholder="Enter amount in USD" min="1" step="0.01" value="">
        </div>

        <div class="input-group">
            <label>Account Number</label>
            <input type="text" id="accountInput" placeholder="10-digit Nigerian account number" maxlength="10">
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="bank-attempt" id="currentBankAttempt">Initializing...</div>
        </div>

        <button class="btn-primary" id="validateBtn">üîç VALIDATE ACCOUNT (Paystack)</button>

        <!-- Matches Section -->
        <div id="matchesSection" class="matches-container" style="display: none;">
            <h3 style="color: #FFD700; margin-bottom: 15px; display: flex; justify-content: space-between;">
                <span>Select Destination Bank:</span>
                <span style="background: #10b98120; color: #10b981; padding: 4px 12px; border-radius: 20px;" id="matchCount">0 matches</span>
            </h3>
            <div id="matchesList"></div>
        </div>

        <div class="info-box" id="validationInfo" style="display: none;">
            <strong>‚úÖ Account Validated:</strong> <span id="validatedName"></span>
        </div>

        <button class="btn-secondary" id="requestApprovalBtn" disabled>üîê REQUEST GOVERNANCE APPROVAL</button>

        <div class="approval-section" id="approvalSection">
            <label>Enter Approval Code</label>
            <input type="text" id="approvalCode" placeholder="6-digit code from Telegram" maxlength="6">
            <div class="warning">Check Empire Telegram channel for your approval code</div>
        </div>

        <button class="btn-success" id="withdrawBtn" disabled>üí∞ EXECUTE TRANSFER (Rubies)</button>
        
    <div id="statusMonitor" style="display: none; margin: 20px 0; background: #1e293b; border-radius: 16px; padding: 20px; border: 1px solid #FFD700;">
    <h3 style="color: #FFD700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
        <span>üîç TRANSACTION STATUS MONITOR</span>
        <span id="liveIndicator" style="background: #10b981; width: 10px; height: 10px; border-radius: 50%; display: inline-block;"></span>
    </h3>
    
    <!-- Current Transaction Details -->
    <div id="currentTxDetails" style="background: #0f172a; border-radius: 12px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span style="color: #94a3b8;">Reference:</span>
            <span style="color: white; font-family: monospace;" id="monitorReference">None</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span style="color: #94a3b8;">Amount:</span>
            <span style="color: #FFD700; font-weight: 600;" id="monitorAmount">‚Ç¶0</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span style="color: #94a3b8;">Status:</span>
            <span style="color: #f59e0b; font-weight: 600;" id="monitorStatus">PROCESSING</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span style="color: #94a3b8;">Last Check:</span>
            <span style="color: white;" id="monitorLastCheck">Just now</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
            <span style="color: #94a3b8;">Time Elapsed:</span>
            <span style="color: white;" id="monitorElapsed">0m</span>
        </div>
    </div>
    
    <!-- Progress Bar -->
    <div style="margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span style="color: #94a3b8; font-size: 12px;">Processing</span>
            <span style="color: #FFD700; font-size: 12px;" id="progressPercentage">0%</span>
        </div>
        <div style="height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
            <div id="statusProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b, #FFD700); transition: width 0.3s ease;"></div>
        </div>
    </div>
    
    <!-- Manual Check Button -->
    <div style="display: flex; gap: 10px;">
        <button onclick="manualStatusCheck()" style="flex: 2; background: #3b82f6; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            üîÑ CHECK STATUS NOW
        </button>
        <button onclick="copyReference()" style="flex: 1; background: #334155; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;" title="Copy reference">
            üìã COPY
        </button>
    </div>
    
    <!-- Status History -->
    <div style="margin-top: 15px;">
        <details>
            <summary style="color: #94a3b8; cursor: pointer; font-size: 13px;">View Status History</summary>
            <div id="statusHistory" style="margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; background: #0f172a; padding: 10px; border-radius: 8px;">
                No history yet
            </div>
        </details>
    </div>
</div>
        <div id="statusMessage" class="status"></div>
        <div id="debug"></div>
    </div>

    <!-- Receipt Modal - NO BALANCE -->
<!-- Receipt Modal -->
<div class="modal-overlay" id="receiptModal">
    <div class="modal-content">
        <div class="receipt-header">
            <div class="receipt-icon">üè∞</div>
            <div class="receipt-title">EMPIRE AFFILIATE MARKETING HUB</div>
            <div class="receipt-subtitle">Official Payment Receipt</div>
            <div class="receipt-subtitle" id="receiptTimestamp"></div>
        </div>
        
        <div class="receipt-details">
            <!-- Receipt ID -->
            <div class="receipt-row">
                <span class="receipt-label">Receipt ID:</span>
                <span class="receipt-value" id="receiptReceiptId"></span>
            </div>
            
            <!-- Transaction ID -->
            <div class="receipt-row">
                <span class="receipt-label">Transaction ID:</span>
                <span class="receipt-value" id="receiptTransactionId"></span>
            </div>
            
            <!-- Date & Time -->
            <div class="receipt-row">
                <span class="receipt-label">Date & Time:</span>
                <span class="receipt-value" id="receiptDateTime"></span>
            </div>
            
            <!-- Status -->
            <div class="receipt-row">
                <span class="receipt-label">Status:</span>
                <span class="receipt-value" id="receiptStatusDisplay"></span>
            </div>
            
            <!-- Amount -->
            <div class="receipt-row">
                <span class="receipt-label">Amount:</span>
                <span class="receipt-value" id="receiptAmount"></span>
            </div>
            
            <!-- Recipient -->
            <div class="receipt-row">
                <span class="receipt-label">Recipient:</span>
                <span class="receipt-value" id="receiptRecipient"></span>
            </div>
            
            <!-- Account -->
            <div class="receipt-row">
                <span class="receipt-label">Account:</span>
                <span class="receipt-value" id="receiptAccount"></span>
            </div>
            
            <!-- Institution -->
            <div class="receipt-row">
                <span class="receipt-label">Institution:</span>
                <span class="receipt-value" id="receiptBank"></span>
            </div>
            
            <!-- Payment Method -->
            <div class="receipt-row">
                <span class="receipt-label">Payment Method:</span>
                <span class="receipt-value">Bank Transfer</span>
            </div>
            
            <!-- Purpose (Editable) -->
            <div class="receipt-row">
                <span class="receipt-label">Purpose:</span>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="receiptPurpose" value="Affiliate payout" 
                           style="background: #2d3a4f; border: 1px solid #FFD700; border-radius: 4px; 
                                  padding: 4px 8px; color: white; width: 160px;">
                    <button onclick="savePurpose()" style="background: #10b981; border: none; 
                            border-radius: 4px; padding: 4px 12px; color: white; cursor: pointer; 
                            font-size: 12px; font-weight: 600;">SAVE</button>
                </div>
            </div>
        </div>
        
        <!-- Official Note -->
        <div style="text-align: center; margin: 20px 0; font-style: italic; color: #94a3b8; font-size: 12px;">
            This is an official receipt from The Empire Payments System
        </div>
        
        <!-- Buttons -->
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="downloadReceipt()" 
                    style="background: #3b82f6; color: white; padding: 10px 20px; border: none; 
                           border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1;
                           transition: all 0.3s;">
                üì• DOWNLOAD RECEIPT
            </button>
            <button onclick="closeReceipt()" 
                    style="background: #FFD700; color: black; padding: 10px 20px; border: none; 
                           border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1;
                           transition: all 0.3s;">
                CLOSE
            </button>
        </div>
    </div>
</div>
    
    <div class="modal-overlay" id="statusModal">
        <div class="modal-content">
            <div class="receipt-header">
                <div class="receipt-icon">‚è≥</div>
                <div class="receipt-title">TRANSACTION STATUS</div>
            </div>
            
            <div class="receipt-details">
                <div class="receipt-row">
                    <span class="receipt-label">Reference</span>
                    <span class="receipt-value" id="statusReference"></span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Current Status</span>
                    <span class="receipt-value" id="statusBadge">
                        <span class="txn-status-badge status-badge-pending">PENDING</span>
                    </span>
                </div>
                <div class="receipt-row">
                    <span class="receipt-label">Last Check</span>
                    <span class="receipt-value" id="lastCheck"></span>
                </div>
            </div>
            
            <div class="progress-bar" style="margin: 20px 0; height: 8px; background: #334155; border-radius: 4px; overflow: hidden;">
                <div class="progress-fill" id="statusProgress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #FFD700, #e6c200); transition: width 0.3s ease;"></div>
            </div>
            
            <div id="statusMessage" style="text-align: center; margin: 10px 0; color: #94a3b8;">
                Most transfers complete within 2-3 hours
            </div>
            
            <div class="receipt-footer" style="display: flex; gap: 10px;">
                <button class="btn-close" onclick="checkStatus()" style="flex: 1; background: #3b82f6;">CHECK AGAIN</button>
                <button class="btn-close" onclick="closeStatusModal()" style="flex: 1; background: #334155;">CLOSE</button>
            </div>
        </div>
    </div>
    <script>
        // ==================== COMPLETE BANK LISTS ====================
        
        // Paystack Bank List (205+ banks from your file)
        const PAYSTACK_BANKS = [
            { code: '120001', name: '9mobile 9Payment Service Bank' },
            { code: '404', name: 'Abbey Mortgage Bank' },
            { code: '51204', name: 'Above Only MFB' },
            { code: '51312', name: 'Abulesoro MFB' },
            { code: '044', name: 'Access Bank' },
            { code: '063', name: 'Access Bank (Diamond)' },
            { code: '602', name: 'Accion Microfinance Bank' },
            { code: '50315', name: 'Aella MFB' },
            { code: '90077', name: 'AG Mortgage Bank' },
            { code: '50036', name: 'Ahmadu Bello University Microfinance Bank' },
            { code: '120004', name: 'Airtel Smartcash PSB' },
            { code: '51336', name: 'AKU Microfinance Bank' },
            { code: '090561', name: 'Akuchukwu Microfinance Bank Limited' },
            { code: '035A', name: 'ALAT by WEMA' },
            { code: '108', name: 'Alpha Morgan Bank' },
            { code: '000304', name: 'Alternative bank' },
            { code: '090629', name: 'Amegy Microfinance Bank' },
            { code: '50926', name: 'Amju Unique MFB' },
            { code: '50083', name: 'Aramoko MFB' },
            { code: '401', name: 'ASO Savings and Loans' },
            { code: '50092', name: 'Assets Microfinance Bank' },
            { code: 'MFB50094', name: 'Astrapolaris MFB LTD' },
            { code: '090478', name: 'AVUENEGBE MICROFINANCE BANK' },
            { code: '51351', name: 'AWACASH MICROFINANCE BANK' },
            { code: '51337', name: 'AZTEC MICROFINANCE BANK LIMITED' },
            { code: '51229', name: 'Bainescredit MFB' },
            { code: '50117', name: 'Banc Corp Microfinance Bank' },
            { code: '50572', name: 'BANKIT MICROFINANCE BANK LTD' },
            { code: '51341', name: 'BANKLY MFB' },
            { code: 'MFB50992', name: 'Baobab Microfinance Bank' },
            { code: '51100', name: 'BellBank Microfinance Bank' },
            { code: '51267', name: 'Benysta Microfinance Bank Limited' },
            { code: '50123', name: 'Beststar Microfinance Bank' },
            { code: '50725', name: 'BOLD MFB' },
            { code: '650', name: 'Bosak Microfinance Bank' },
            { code: '50931', name: 'Bowen Microfinance Bank' },
            { code: 'FC40163', name: 'Branch International Finance Company Limited' },
            { code: '50645', name: 'BuyPower MFB' },
            { code: '565', name: 'Carbon' },
            { code: '51353', name: 'Cashbridge Microfinance Bank Limited' },
            { code: '865', name: 'CASHCONNECT MFB' },
            { code: '50823', name: 'CEMCS Microfinance Bank' },
            { code: '50171', name: 'Chanelle Microfinance Bank Limited' },
            { code: '312', name: 'Chikum Microfinance bank' },
            { code: '023', name: 'Citibank Nigeria' },
            { code: '070027', name: 'CITYCODE MORTAGE BANK' },
            { code: '50910', name: 'Consumer Microfinance Bank' },
            { code: '50204', name: 'Corestep MFB' },
            { code: '559', name: 'Coronation Merchant Bank' },
            { code: 'FC40128', name: 'County Finance Limited' },
            { code: '40119', name: 'Credit Direct Limited' },
            { code: '51297', name: 'Crescent MFB' },
            { code: '090560', name: 'Crust Microfinance Bank' },
            { code: '50216', name: 'CRUTECH MICROFINANCE BANK LTD' },
            { code: '51334', name: 'Davenport MICROFINANCE BANK' },
            { code: '51450', name: 'Dillon Microfinance Bank' },
            { code: '50162', name: 'Dot Microfinance Bank' },
            { code: '50922', name: 'EBSU Microfinance Bank' },
            { code: '050', name: 'Ecobank Nigeria' },
            { code: '50263', name: 'Ekimogun MFB' },
            { code: '098', name: 'Ekondo Microfinance Bank' },
            { code: '090678', name: 'EXCEL FINANCE BANK' },
            { code: '50126', name: 'Eyowo' },
            { code: '51318', name: 'Fairmoney Microfinance Bank' },
            { code: '50298', name: 'Fedeth MFB' },
            { code: '070', name: 'Fidelity Bank' },
            { code: '51314', name: 'Firmus MFB' },
            { code: '011', name: 'First Bank of Nigeria' },
            { code: '214', name: 'First City Monument Bank' },
            { code: '090164', name: 'FIRST ROYAL MICROFINANCE BANK' },
            { code: '51333', name: 'FIRSTMIDAS MFB' },
            { code: '413', name: 'FirstTrust Mortgage Bank Nigeria' },
            { code: '501', name: 'FSDH Merchant Bank Limited' },
            { code: '832', name: 'FUTMINNA MICROFINANCE BANK' },
            { code: 'MFB51093', name: 'Garun Mallam MFB' },
            { code: '812', name: 'Gateway Mortgage Bank LTD' },
            { code: '00103', name: 'Globus Bank' },
            { code: '090574', name: 'Goldman MFB' },
            { code: '100022', name: 'GoMoney' },
            { code: '090664', name: 'GOOD SHEPHERD MICROFINANCE BANK' },
            { code: '50739', name: 'Goodnews Microfinance Bank' },
            { code: '562', name: 'Greenwich Merchant Bank' },
            { code: '51276', name: 'GROOMING MICROFINANCE BANK' },
            { code: '50368', name: 'GTI MFB' },
            { code: '058', name: 'Guaranty Trust Bank' },
            { code: '51251', name: 'Hackman Microfinance Bank' },
            { code: '50383', name: 'Hasal Microfinance Bank' },
            { code: '120002', name: 'HopePSB' },
            { code: '51211', name: 'IBANK Microfinance Bank' },
            { code: '51279', name: 'IBBU MFB' },
            { code: '51244', name: 'Ibile Microfinance Bank' },
            { code: '90012', name: 'Ibom Mortgage Bank' },
            { code: '50439', name: 'Ikoyi Osun MFB' },
            { code: '50442', name: 'Ilaro Poly Microfinance Bank' },
            { code: '50453', name: 'Imowo MFB' },
            { code: '415', name: 'IMPERIAL HOMES MORTAGE BANK' },
            { code: '51392', name: 'INDULGE MFB' },
            { code: '50457', name: 'Infinity MFB' },
            { code: '070016', name: 'Infinity trust Mortgage Bank' },
            { code: '090701', name: 'ISUA MFB' },
            { code: '301', name: 'Jaiz Bank' },
            { code: '50502', name: 'Kadpoly MFB' },
            { code: '51308', name: 'KANOPOLY MFB' },
            { code: '082', name: 'Keystone Bank' },
            { code: '899', name: 'Kolomoni MFB' },
            { code: '100025', name: 'KONGAPAY (Kongapay Technologies Limited)' },
            { code: '50200', name: 'Kredi Money MFB LTD' },
            { code: '50211', name: 'Kuda Bank' },
            { code: '90052', name: 'Lagos Building Investment Company Plc.' },
            { code: '090420', name: 'Letshego Microfinance Bank' },
            { code: '50549', name: 'Links MFB' },
            { code: '031', name: 'Living Trust Mortgage Bank' },
            { code: '50491', name: 'LOMA MFB' },
            { code: '303', name: 'Lotus Bank' },
            { code: '090171', name: 'MAINSTREET MICROFINANCE BANK' },
            { code: '50563', name: 'Mayfair MFB' },
            { code: '50304', name: 'Mint MFB' },
            { code: '946', name: 'Money Master PSB' },
            { code: '50515', name: 'Moniepoint MFB' },
            { code: '120003', name: 'MTN Momo PSB' },
            { code: '090190', name: 'MUTUAL BENEFITS MICROFINANCE BANK' },
            { code: '090679', name: 'NDCC MICROFINANCE BANK' },
            { code: '51361', name: 'NET MICROFINANCE BANK' },
            { code: '51142', name: 'Nigerian Navy Microfinance Bank Limited' },
            { code: '50072', name: 'Nombank MFB' },
            { code: '561', name: 'NOVA BANK' },
            { code: '51371', name: 'Novus MFB' },
            { code: '50629', name: 'NPF MICROFINANCE BANK' },
            { code: '51261', name: 'NSUK MICROFINANACE BANK' },
            { code: '50697', name: 'OLUCHUKWU MICROFINANCE BANK LTD' },
            { code: '999992', name: 'OPay Digital Services Limited (OPay)' },
            { code: '107', name: 'Optimus Bank Limited' },
            { code: '100002', name: 'Paga' },
            { code: '999991', name: 'PalmPay' },
            { code: '104', name: 'Parallex Bank' },
            { code: '311', name: 'Parkway - ReadyCash' },
            { code: '090680', name: 'PATHFINDER MICROFINANCE BANK LIMITED' },
            { code: '100039', name: 'Paystack-Titan' },
            { code: '50743', name: 'Peace Microfinance Bank' },
            { code: '51226', name: 'PECANTRUST MICROFINANCE BANK LIMITED' },
            { code: '51146', name: 'Personal Trust MFB' },
            { code: '50746', name: 'Petra Mircofinance Bank Plc' },
            { code: 'MFB51452', name: 'Pettysave MFB' },
            { code: '050021', name: 'PFI FINANCE COMPANY LIMITED' },
            { code: '268', name: 'Platinum Mortgage Bank' },
            { code: '00716', name: 'Pocket App' },
            { code: '076', name: 'Polaris Bank' },
            { code: '50864', name: 'Polyunwana MFB' },
            { code: '105', name: 'PremiumTrust Bank' },
            { code: '50739', name: 'Prospa Capital Microfinance Bank' },
            { code: '050023', name: 'PROSPERIS FINANCE LIMITED' },
            { code: '101', name: 'Providus Bank' },
            { code: '51293', name: 'QuickFund MFB' },
            { code: '502', name: 'Rand Merchant Bank' },
            { code: '090496', name: 'RANDALPHA MICROFINANCE BANK' },
            { code: '90067', name: 'Refuge Mortgage Bank' },
            { code: '50761', name: 'REHOBOTH MICROFINANCE BANK' },
            { code: '50994', name: 'Rephidim Microfinance Bank' },
            { code: '51286', name: 'Rigo Microfinance Bank Limited' },
            { code: '50767', name: 'ROCKSHIELD MICROFINANCE BANK' },
            { code: '125', name: 'Rubies MFB' },
            { code: '51113', name: 'Safe Haven MFB' },
            { code: '40165', name: 'SAGE GREY FINANCE LIMITED' },
            { code: '50582', name: 'Shield MFB' },
            { code: '106', name: 'Signature Bank Ltd' },
            { code: '51062', name: 'Solid Allianze MFB' },
            { code: '50800', name: 'Solid Rock MFB' },
            { code: '51310', name: 'Sparkle Microfinance Bank' },
            { code: '51429', name: 'Springfield Microfinance Bank' },
            { code: '221', name: 'Stanbic IBTC Bank' },
            { code: '068', name: 'Standard Chartered Bank' },
            { code: '090162', name: 'STANFORD MICROFINANCE BANK' },
            { code: '50809', name: 'STATESIDE MICROFINANCE BANK' },
            { code: '070022', name: 'STB Mortgage Bank' },
            { code: '51253', name: 'Stellas MFB' },
            { code: '232', name: 'Sterling Bank' },
            { code: '100', name: 'Suntrust Bank' },
            { code: '50968', name: 'Supreme MFB' },
            { code: '302', name: 'TAJ Bank' },
            { code: '51269', name: 'Tangerine Money' },
            { code: '51403', name: 'TENN' },
            { code: '102', name: 'Titan Bank' },
            { code: '090708', name: 'TransPay MFB' },
            { code: '50840', name: 'U&C Microfinance Bank Ltd (U AND C MFB)' },
            { code: '090706', name: 'UCEE MFB' },
            { code: '51322', name: 'Uhuru MFB' },
            { code: '51080', name: 'Ultraviolet Microfinance Bank' },
            { code: '50870', name: 'Unaab Microfinance Bank Limited' },
            { code: '51447', name: 'UNIABUJA MFB' },
            { code: '50871', name: 'Unical MFB' },
            { code: '51316', name: 'Unilag Microfinance Bank' },
            { code: '50875', name: 'UNIMAID MICROFINANCE BANK' },
            { code: '032', name: 'Union Bank of Nigeria' },
            { code: '033', name: 'United Bank For Africa' },
            { code: '215', name: 'Unity Bank' },
            { code: '50894', name: 'Uzondu Microfinance Bank Awka Anambra State' },
            { code: '050020', name: 'Vale Finance Limited' },
            { code: '566', name: 'VFD Microfinance Bank Limited' },
            { code: '51355', name: 'Waya Microfinance Bank' },
            { code: '035', name: 'Wema Bank' },
            { code: '51386', name: 'Weston Charis MFB' },
            { code: '100040', name: 'Xpress Wallet' },
            { code: '594', name: 'Yes MFB' },
            { code: '057', name: 'Zenith Bank' }
        ];

        // Rubies Bank List (800+ banks from your file - partial shown, full list in actual implementation)
        const RUBIES_BANKS = [
            { code: '110005', name: '3LINE CARD MANAGEMENT' },
            { code: '110072', name: '78 FINANCE COMPANY' },
            { code: '120001', name: '9 PAYMENT SERVICE BANK' },
            { code: '090629', name: '9JAPAY MFB' },
            { code: '050005', name: 'AAA FINANCE' },
            { code: '090270', name: 'AB MFB' },
            { code: '070010', name: 'ABBEY MORTGAGE BANK' },
            { code: '090260', name: 'ABOVE ONLY MFB' },
            { code: '090640', name: 'ABSU MFB' },
            { code: '090197', name: 'ABU MFB' },
            { code: '090424', name: 'ABUCOOP  MFB' },
            { code: '090545', name: 'ABULESORO MFB' },
            { code: '090202', name: 'ACCELEREX NETWORK' },
            { code: '000014', name: 'ACCESS BANK' },
            { code: '000005', name: 'ACCESS BANK' },
            { code: '100013', name: 'ACCESSMONEY' },
            { code: '090134', name: 'ACCION MFB' },
            { code: '090483', name: 'ADA MFB' },
            { code: '090160', name: 'ADDOSSER MFB' },
            { code: '090268', name: 'ADEYEMI COLLEGE STAFF MFB' },
            { code: '090759', name: 'ADVANCLY MFB' },
            { code: '090155', name: 'ADVANS LA FAYETTE MFB' },
            { code: '090614', name: 'AELLA MFB' },
            { code: '090292', name: 'AFEKHAFE MFB' },
            { code: '090518', name: 'AFEMAI MFB' },
            { code: '100028', name: 'AG MORTGAGE BANK' },
            { code: '090371', name: 'AGOSASA MFB' },
            { code: '090698', name: 'AKALABO MFB' },
            { code: '090608', name: 'AKPO MFB' },
            { code: '090531', name: 'AKU MFB' },
            { code: '090561', name: 'AKUCHUKWU MFB' },
            { code: '070025', name: 'AKWA SAVINGS  & LOANS' },
            { code: '090133', name: 'AL-BARAKAH MFB' },
            { code: '090259', name: 'ALEKUN MFB' },
            { code: '090297', name: 'ALERT MFB' },
            { code: '090277', name: 'ALHAYAT MFB' },
            { code: '090131', name: 'ALLWORKERS MFB' },
            { code: '090548', name: 'ALLY MFB' },
            { code: '090169', name: 'ALPHA KAPITAL MFB' },
            { code: '000037', name: 'ALTERNATIVE BANK' },
            { code: '090489', name: 'ALVANA MFB' },
            { code: '090394', name: 'AMAC MFB' },
            { code: '090180', name: 'AMJU MFB' },
            { code: '090116', name: 'AMML MFB' },
            { code: '090610', name: 'AMOYE MFB' },
            { code: '090476', name: 'ANCHORAGE MFB' },
            { code: '090469', name: 'ANIOCHA MFB' },
            { code: '090143', name: 'APEKS MFB' },
            { code: '090376', name: 'APPLE  MFB' },
            { code: '090307', name: 'ARAMOKO MFB' },
            { code: '110011', name: 'ARCA PAYMENTS' },
            { code: '090282', name: 'ARISE MFB' },
            { code: '090816', name: 'ARM MFB' },
            { code: '090001', name: 'ASO SAVINGS  & LOANS' },
            { code: '090544', name: 'ASPIRE MFB' },
            { code: '070033', name: 'ASPIRE MORTGAGE BANK' },
            { code: '090287', name: 'ASSETS MATRIX MFB' },
            { code: '090473', name: 'ASSETS MFB' },
            { code: '090172', name: 'ASTRA POLARIS MFB' },
            { code: '090451', name: 'ATBU  MFB' },
            { code: '090264', name: 'AUCHI MFB' },
            { code: '090600', name: 'AVE MARIA MFB' },
            { code: '090478', name: 'AVUENEGBE MFB' },
            { code: '090633', name: 'AWACASH MFB' },
            { code: '090693', name: 'AWE MFB' },
            { code: '090662', name: 'AWESOME MFB' },
            { code: '090540', name: 'AZTEC MFB' }
        ];

        // Rubies API key mapping (you'll need to complete this based on your Rubies list)
        function getRubiesCode(paystackCode, bankName) {
            // Manual mapping for major banks
            const manualMap = {
                '044': '000005', // Access Bank
                '058': '000013', // GTBank
                '057': '000015', // Zenith
                '033': '000004', // UBA
                '011': '000016', // First Bank
                '070': '000007', // Fidelity
                '214': '000003', // FCMB
                '035': '000017', // Wema
                '032': '000018', // Union Bank
                '076': '000008', // Polaris
                '050': '000010', // Ecobank
                '221': '000012', // Stanbic
                '068': '000021', // Standard Chartered
                '082': '000002', // Keystone
                '301': '000006', // Jaiz
                '023': '000009', // Citibank
                '999992': '100004', // OPay
                '50211': '090267', // Kuda
                '999991': '100033', // PalmPay
                '50515': '090405', // Moniepoint
                '125': '090175', // Rubies
                '035A': '000017', // ALAT
                '00103': '000027', // Globus
                '105': '000031', // PremiumTrust
                '106': '000034', // Signature
                '101': '000023', // Providus
                '100': '000022', // Suntrust
                '302': '000026', // TAJ Bank
                '303': '000029', // Lotus Bank
                '566': '090110', // VFD
                '565': '100026', // Carbon
            };
            
            return manualMap[paystackCode] || '000001'; // Default to Sterling if not found
        }

        // ==================== CONFIG ====================
        const CONFIG = {
            PAYSTACK_KEY: 'sk_live_4b951926b192f505be7b9eac54b039a7642458d5',
            TELEGRAM_TOKEN: '7868469400:AAHpNI1wbKjMBdS6DKYFxcpPsoa_nNkSF34',
            TELEGRAM_CHAT: '-1002604596144',
            USD_TO_NGN: 1430.80,
            EDGE_URL: 'https://qujlyrmatuvlpoeheqgf.supabase.co/functions/v1/empire-wallet-transfer',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1amx5cm1hdHV2bHBvZWhlcWdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwOTE5NDUsImV4cCI6MjA2NzY2Nzk0NX0.PgIRCU_-r6o-u6AIhj52FE1iezdwt3wpi-a9zQvAdsc'
        };

        // ==================== STATE ====================
        let state = {
            balance: 184362.87,
            matches: [],
            selectedMatch: null,
            approvalCode: null,
            currentTransaction: null
        };

        let statusCheckInterval = null;

        // ==================== UI HELPERS ====================
        function showStatus(message, type) {
            const el = document.getElementById('statusMessage');
            el.className = `status ${type}`;
            el.innerHTML = message;
        }

        function debug(message) {
            console.log(message);
            document.getElementById('debug').innerHTML = String(message);
        }

        function updateBalanceDisplay() {
            document.getElementById('balanceDisplay').innerText = '$' + state.balance.toFixed(2);
        }

        function showProgress(show, bankName) {
            const container = document.getElementById('progressContainer');
            if (show) {
                container.style.display = 'block';
                if (bankName) {
                    document.getElementById('currentBankAttempt').innerHTML = 
                        `<span class="spinner"></span>Checking ${bankName}...`;
                }
            } else {
                container.style.display = 'none';
            }
        }

        function updateProgress(percent, bankName) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (bankName) {
                document.getElementById('currentBankAttempt').innerHTML = 
                    `<span class="spinner"></span>Checking ${bankName}...`;
            }
        }

        // ==================== RECEIPT MODAL ====================
        // ================= RECEIPT MODAL WITH AUTO STATUS CHECKING =================

// ==================== SHOW RECEIPT ====================
function showReceipt(transactionData) {
    const receiptId = 'RCP-' + Date.now().toString().slice(-8);
    const now = new Date();
    
    document.getElementById('receiptReceiptId').innerText = receiptId;
    document.getElementById('receiptTransactionId').innerText = transactionData.reference;
    document.getElementById('receiptDateTime').innerText = now.toLocaleString();
    document.getElementById('receiptStatusDisplay').innerText = transactionData.status.toUpperCase();
    document.getElementById('receiptAmount').innerText = transactionData.amountNGN;
    document.getElementById('receiptRecipient').innerText = transactionData.accountName;
    document.getElementById('receiptAccount').innerText = transactionData.accountNumber;
    document.getElementById('receiptBank').innerText = transactionData.bankName;
    
    state.currentTransaction = { ...transactionData, receiptId };
    document.getElementById('receiptModal').classList.add('active');
}

// ==================== SAVE PURPOSE ====================
window.savePurpose = function() {
    const purpose = document.getElementById('receiptPurpose').value;
    if (state.currentTransaction) {
        state.currentTransaction.narration = purpose;
        showStatus('‚úÖ Purpose updated', 'success');
    }
};

// ==================== DOWNLOAD RECEIPT ====================
window.downloadReceipt = function() {
    if (!state.currentTransaction) return;
    
    const purpose = document.getElementById('receiptPurpose').value;
    const content = `
EMPIRE AFFILIATE MARKETING HUB
Official Payment Receipt

Receipt ID: ${document.getElementById('receiptReceiptId').innerText}
Transaction ID: ${document.getElementById('receiptTransactionId').innerText}
Date & Time: ${document.getElementById('receiptDateTime').innerText}
Status: ${document.getElementById('receiptStatusDisplay').innerText}

Amount: ${document.getElementById('receiptAmount').innerText}
Recipient: ${document.getElementById('receiptRecipient').innerText}
Account: ${document.getElementById('receiptAccount').innerText}
Institution: ${document.getElementById('receiptBank').innerText}
Payment Method: Bank Transfer
Purpose: ${purpose}

This is an official receipt from The Empire Payments System
    `;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `receipt-${document.getElementById('receiptReceiptId').innerText}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showStatus('‚úÖ Receipt downloaded', 'success');
};

// ==================== CLOSE RECEIPT ====================
window.closeReceipt = function() {
    document.getElementById('receiptModal').classList.remove('active');
};

// ================= AUTO STATUS CHECKER FUNCTIONS =================
async function checkTransactionStatus(reference) {
    try {
        const response = await fetch(`${CONFIG.EDGE_URL}/status?reference=${reference}`, {
            headers: { 'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY }
        });
        const data = await response.json();
        
        console.log('Status check:', data);
        
        if (data.status === 'completed') {
            // Transaction completed!
            clearInterval(statusCheckInterval);
            showStatus('‚úÖ Transfer completed! Money sent to bank.', 'success');
            
            // Update receipt if open
            if (document.getElementById('receiptModal').style.display === 'flex') {
                document.getElementById('receiptStatus').innerHTML = 
                    '<span class="txn-status-badge status-badge-success">COMPLETED</span>';
            }
            
            // Show completion message
            alert(`‚úÖ Transfer Completed!\nReference: ${reference}\nFunds should be in your account now.`);
            
        } else if (data.status === 'failed') {
            // Transaction failed
            clearInterval(statusCheckInterval);
            showStatus('‚ùå Transfer failed. Funds will be restored.', 'error');
            
            // Refund wallet
            const amount = parseFloat(document.getElementById('amount').value);
            state.balance += amount;
            updateBalanceDisplay();
        }
        
        return data;
    } catch (err) {
        console.error('Status check error:', err);
    }
}

function startStatusChecking(reference) {
    // Check immediately
    checkTransactionStatus(reference);
    
    // Then check every 30 seconds
    statusCheckInterval = setInterval(() => {
        checkTransactionStatus(reference);
    }, 30000);
}

// Manual status check button
window.checkStatus = async function() {
    if (state.currentTransaction) {
        const data = await checkTransactionStatus(state.currentTransaction.reference);
        
        document.getElementById('lastCheck').innerText = new Date().toLocaleTimeString();
        
        // Update progress based on time elapsed
        const created = new Date(state.currentTransaction.createdAt || Date.now());
        const elapsed = Date.now() - created;
        const maxWait = 3 * 60 * 60 * 1000; // 3 hours
        const progress = Math.min(100, (elapsed / maxWait) * 100);
        document.getElementById('statusProgress').style.width = progress + '%';
    }
};

window.closeStatusModal = function() {
    document.getElementById('statusModal').style.display = 'none';
};

// Clear interval on page unload
window.onbeforeunload = function() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
};

        // ==================== FETCH BALANCE ====================
        async function fetchBalance() {
            try {
                const res = await fetch(CONFIG.EDGE_URL + '/balance?userId=system', {
                    headers: { 'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY }
                });
                const data = await res.json();
                if (data.balance) {
                    state.balance = parseFloat(data.balance);
                    updateBalanceDisplay();
                }
            } catch (err) {
                debug('Using default balance: $' + state.balance);
            }
        }

        // ==================== VALIDATE ACCOUNT ====================
        window.validateAccount = async function() {
            const account = document.getElementById('accountInput').value.trim();
            
            if (!account || !/^\d{10}$/.test(account)) {
                showStatus('Please enter a valid 10-digit account number', 'error');
                return;
            }

            showProgress(true, 'Starting validation...');
            document.getElementById('validateBtn').disabled = true;
            showStatus('Searching ALL Nigerian banks (205+ institutions)...', 'info');

            try {
                state.matches = [];
                let checkedCount = 0;
                
                // Try ALL Paystack banks
                for (let i = 0; i < PAYSTACK_BANKS.length; i++) {
                    const bank = PAYSTACK_BANKS[i];
                    checkedCount++;
                    const percent = Math.round((checkedCount / PAYSTACK_BANKS.length) * 100);
                    
                    updateProgress(percent, bank.name);
                    
                    // Add small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                    try {
                        const response = await fetch(
                            `https://api.paystack.co/bank/resolve?account_number=${account}&bank_code=${bank.code}`,
                            { 
                                headers: { 
                                    'Authorization': 'Bearer ' + CONFIG.PAYSTACK_KEY,
                                    'Content-Type': 'application/json'
                                } 
                            }
                        );

                        const data = await response.json();
                        
                        if (data.status && data.data) {
                            // Found a match!
                            const rubiesCode = getRubiesCode(bank.code, bank.name);
                            state.matches.push({
                                name: data.data.account_name,
                                account: account,
                                bank: bank.name,
                                code: bank.code,
                                rubiesCode: rubiesCode,
                                paystackCode: bank.code
                            });
                            debug('‚úÖ Found: ' + bank.name);
                        }
                    } catch (e) {
                        // Bank doesn't have this account - skip silently
                    }
                }

                showProgress(false);

                if (state.matches.length === 0) {
                    showStatus('No account found with any Nigerian bank', 'error');
                    document.getElementById('validateBtn').disabled = false;
                    return;
                }

                // Display ALL matches
                displayMatches(state.matches);
                
                document.getElementById('matchCount').innerText = 
                    state.matches.length + ' match' + (state.matches.length > 1 ? 'es' : '');
                
                showStatus('‚úÖ Found ' + state.matches.length + ' account(s)! Select one.', 'success');
                document.getElementById('requestApprovalBtn').disabled = false;

            } catch (err) {
                showStatus('Validation failed: ' + err.message, 'error');
                debug('Error: ' + err.message);
            } finally {
                document.getElementById('validateBtn').disabled = false;
                showProgress(false);
            }
        };

        function displayMatches(matchesArray) {
            const matchesDiv = document.getElementById('matchesList');
            const matchesSection = document.getElementById('matchesSection');
            
            matchesDiv.innerHTML = '';
            
            matchesArray.forEach((match, index) => {
                const div = document.createElement('div');
                div.className = 'match-item' + (index === 0 ? ' selected' : '');
                div.onclick = () => selectMatch(index);
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="match-name">${match.name}</span>
                        <span class="match-badge">‚úì Validated</span>
                    </div>
                    <div class="match-details">
                        <span class="match-bank">${match.bank}</span>
                        <span>Code: ${match.code}</span>
                    </div>
                `;
                matchesDiv.appendChild(div);
            });
            
            matchesSection.style.display = 'block';
            
            // Auto-select first match
            selectMatch(0);
        }

        function selectMatch(index) {
            document.querySelectorAll('.match-item').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.match-item')[index]?.classList.add('selected');
            state.selectedMatch = state.matches[index];
            
            document.getElementById('validatedName').innerHTML = 
                `${state.selectedMatch.name} - ${state.selectedMatch.bank}`;
            document.getElementById('validationInfo').style.display = 'block';
        }

        // ==================== REQUEST APPROVAL ====================
        window.requestGovernanceApproval = async function() {
            if (!state.selectedMatch) {
                showStatus('Please select an account first', 'error');
                return;
            }

            const amount = parseFloat(document.getElementById('amount').value);
            if (amount > state.balance) {
                showStatus('Insufficient balance: $' + state.balance, 'error');
                return;
            }

            state.approvalCode = Math.floor(100000 + Math.random() * 900000).toString();
            
            const amountNGN = Math.round(amount * CONFIG.USD_TO_NGN);
            const message = `üè∞ THE EMPIRE WITHDRAWAL CODE\n\n` +
                `üîê Code: ${state.approvalCode}\n` +
                `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                `üí∞ Amount: $${amount} (‚Ç¶${amountNGN.toLocaleString()})\n` +
                `üë§ Account: ${state.selectedMatch.name}\n` +
                `üè¶ Bank: ${state.selectedMatch.bank}\n` +
                `üì± Number: ${state.selectedMatch.account}\n` +
                `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                `‚è∞ ${new Date().toLocaleString()}`;

            try {
                await fetch('https://api.telegram.org/bot' + CONFIG.TELEGRAM_TOKEN + '/sendMessage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        chat_id: CONFIG.TELEGRAM_CHAT, 
                        text: message 
                    })
                });
                showStatus('‚úÖ Approval code sent to Telegram!', 'success');
            } catch (err) {
                showStatus('‚ö†Ô∏è Use code: ' + state.approvalCode, 'info');
            }

            document.getElementById('approvalSection').style.display = 'block';
            document.getElementById('withdrawBtn').disabled = false;
        };

        // ==================== EXECUTE WITHDRAWAL ====================
        window.executeWithdrawal = async function() {
            const userCode = document.getElementById('approvalCode').value.trim();
            
            if (userCode !== state.approvalCode) {
                showStatus('‚ùå Invalid approval code', 'error');
                return;
            }

            if (!state.selectedMatch) {
                showStatus('No account selected', 'error');
                return;
            }

            const amountUSD = parseFloat(document.getElementById('amount').value);
            const amountNGN = Math.round(amountUSD * CONFIG.USD_TO_NGN);
            const reference = 'EMP-' + Date.now() + '-' + Math.floor(Math.random() * 10000);

            showStatus('‚è≥ Processing transfer...', 'pending');
            document.getElementById('withdrawBtn').disabled = true;

            // Optimistic deduction
            const oldBalance = state.balance;
            state.balance -= amountUSD;
            updateBalanceDisplay();

            const payload = {
                reference: reference,
                amount: amountNGN.toString(),
                usdAmount: amountUSD.toString(),
                narration: 'Empire wallet withdrawal',
                creditAccountName: state.selectedMatch.name,
                creditAccountNumber: state.selectedMatch.account,
                bankCode: state.selectedMatch.rubiesCode,
                paystackBankCode: state.selectedMatch.code,
                bankName: state.selectedMatch.bank,
                approvalCode: userCode,
                userId: 'system'
            };

            try {
                const res = await fetch(CONFIG.EDGE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                debug('Edge response: ' + JSON.stringify(data));

                state.currentTransaction = {
                    amountNGN: '‚Ç¶' + amountNGN.toLocaleString(),
                    accountName: state.selectedMatch.name,
                    bankName: state.selectedMatch.bank,
                    accountNumber: state.selectedMatch.account,
                    reference: data.reference || reference,
                   status: data.status || 'pending',
                   narration: 'Empire wallet withdrawal'  // ‚úÖ ADD THIS LINE
                };

                if (res.ok) {
                    showStatus('‚úÖ Transfer initiated!', 'success');
                    showStatusMonitor(state.currentTransaction);
                    showReceipt(state.currentTransaction);
                    
                    // Reset form
                    setTimeout(() => {
                        document.getElementById('accountInput').value = '';
                        document.getElementById('amount').value = '100';
                        document.getElementById('matchesSection').style.display = 'none';
                        document.getElementById('approvalSection').style.display = 'none';
                        document.getElementById('validationInfo').style.display = 'none';
                        document.getElementById('approvalCode').value = '';
                        document.getElementById('requestApprovalBtn').disabled = true;
                        document.getElementById('withdrawBtn').disabled = true;
                        state.selectedMatch = null;
                        state.approvalCode = null;
                    }, 3000);

                } else {
                    // Restore balance on failure
                    state.balance = oldBalance;
                    updateBalanceDisplay();
                    showStatus('‚ùå Transfer failed: ' + (data.error || 'Unknown'), 'error');
                    document.getElementById('withdrawBtn').disabled = false;
                }

            } catch (err) {
                state.balance = oldBalance;
                updateBalanceDisplay();
                showStatus('Network error: ' + err.message, 'error');
                document.getElementById('withdrawBtn').disabled = false;
                debug('Error: ' + err.message);
            }
        };

        // ==================== STATUS MONITOR ====================
let statusHistory = [];
let monitorInterval = null;

// Show monitor with transaction details
function showStatusMonitor(transaction) {
    const monitor = document.getElementById('statusMonitor');
    if (!monitor) return;
    
    monitor.style.display = 'block';
    
    // Update details
    document.getElementById('monitorReference').innerText = transaction.reference;
    document.getElementById('monitorAmount').innerText = transaction.amountNGN;
    document.getElementById('monitorStatus').innerText = transaction.status.toUpperCase();
    document.getElementById('monitorLastCheck').innerText = new Date().toLocaleTimeString();
    
    // Start live updates
    if (monitorInterval) clearInterval(monitorInterval);
    monitorInterval = setInterval(updateMonitor, 30000); // Update every 30 seconds
    updateElapsedTime();
}

// Update monitor with latest status
function updateMonitor() {
    if (!state.currentTransaction) return;
    
    const reference = state.currentTransaction.reference;
    document.getElementById('monitorLastCheck').innerText = new Date().toLocaleTimeString();
    
    fetch(`${CONFIG.EDGE_URL}/status?reference=${reference}`, {
        headers: { 'Authorization': 'Bearer ' + CONFIG.SUPABASE_KEY }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status) {
            const status = data.status.toUpperCase();
            document.getElementById('monitorStatus').innerText = status;
            
            // Update color based on status
            const statusEl = document.getElementById('monitorStatus');
            statusEl.style.color = status === 'COMPLETED' ? '#10b981' : 
                                   status === 'FAILED' ? '#ef4444' : '#f59e0b';
            
            // Add to history
            addToStatusHistory(status);
            
            // Update progress bar
            updateProgressBar(status);
            
            // If completed or failed, stop interval
            if (status === 'COMPLETED' || status === 'FAILED') {
                if (monitorInterval) clearInterval(monitorInterval);
                document.getElementById('liveIndicator').style.background = 
                    status === 'COMPLETED' ? '#10b981' : '#ef4444';
            }
        }
    })
    .catch(err => {
        console.log('Monitor update failed:', err);
        document.getElementById('monitorLastCheck').innerText = 'Error: ' + new Date().toLocaleTimeString();
    });
    
    updateElapsedTime();
}

// Update elapsed time
function updateElapsedTime() {
    if (!state.currentTransaction?.createdAt) return;
    
    const start = new Date(state.currentTransaction.createdAt);
    const now = new Date();
    const diffMs = now - start;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const mins = diffMins % 60;
    
    let elapsedText = '';
    if (diffHours > 0) {
        elapsedText = `${diffHours}h ${mins}m`;
    } else {
        elapsedText = `${diffMins}m`;
    }
    
    document.getElementById('monitorElapsed').innerText = elapsedText;
    
    // Update progress bar percentage (max 24 hours = 100%)
    const progressPercent = Math.min(100, (diffMs / (24 * 3600000)) * 100);
    document.getElementById('progressPercentage').innerText = Math.round(progressPercent) + '%';
    document.getElementById('statusProgressBar').style.width = progressPercent + '%';
}

// Add to status history
function addToStatusHistory(status) {
    const timestamp = new Date().toLocaleTimeString();
    statusHistory.unshift(`${timestamp} - ${status}`);
    
    if (statusHistory.length > 10) statusHistory.pop();
    
    const historyEl = document.getElementById('statusHistory');
    if (historyEl) {
        historyEl.innerHTML = statusHistory.map(s => 
            `<div style="padding: 4px 0; border-bottom: 1px solid #334155;">${s}</div>`
        ).join('');
    }
}

// Manual status check
window.manualStatusCheck = function() {
    if (!state.currentTransaction) {
        alert('No active transaction');
        return;
    }
    
    document.getElementById('monitorLastCheck').innerText = 'Checking...';
    updateMonitor();
};

// Copy reference to clipboard
window.copyReference = function() {
    const ref = document.getElementById('monitorReference').innerText;
    if (ref && ref !== 'None') {
        navigator.clipboard.writeText(ref);
        alert('Reference copied to clipboard');
    }
};

// ==================== INIT ====================
window.onload = function() {
    updateBalanceDisplay();
    fetchBalance();
    showStatus('‚úÖ Empire Ready', 'info');
    
    document.getElementById('validateBtn').onclick = validateAccount;
    document.getElementById('requestApprovalBtn').onclick = requestGovernanceApproval;
    document.getElementById('withdrawBtn').onclick = executeWithdrawal;
};
        
        // ==================== INIT ====================
        window.onload = function() {
            updateBalanceDisplay();
            fetchBalance();
            showStatus('‚úÖ Empire Ready - ' + PAYSTACK_BANKS.length + ' banks available', 'info');
            debug('Loaded ' + PAYSTACK_BANKS.length + ' Nigerian banks');
            
            // Attach event listeners
            document.getElementById('validateBtn').onclick = validateAccount;
            document.getElementById('requestApprovalBtn').onclick = requestGovernanceApproval;
            document.getElementById('withdrawBtn').onclick = executeWithdrawal;
        };
    </script>
</body>

</html>


